<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedulytics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #4CAF50;
            background: #f0fff0;
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #666;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
        }

        .results {
            display: none;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            padding: 30px;
            min-height: 400px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .project-info {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .activities-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .activities-table th,
        .activities-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .activities-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #666;
        }

        .activities-table tr:hover {
            background: #f8f9ff;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-not-started {
            background: #ffeaa7;
            color: #d63031;
        }

        .status-active {
            background: #81ecec;
            color: #00b894;
        }

        .status-complete {
            background: #a29bfe;
            color: #6c5ce7;
        }

        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.9rem;
            font-weight: bold;
            color: #666;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ffe6e6;
            color: #d63031;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #d63031;
            margin: 20px 0;
        }

        .success {
            background: #e6ffe6;
            color: #00b894;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #00b894;
            margin: 20px 0;
        }

        .export-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .export-section h4 {
            color: #333;
            margin: 15px 0 10px 0;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .export-section h4:first-of-type {
            margin-top: 0;
        }

        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .export-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .critical-activity {
            background: #ffe6e6 !important;
        }

        .resource-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .resource-card {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .resource-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .resource-type {
            color: #666;
            font-size: 0.9rem;
        }

        .assignments-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .assignments-table th,
        .assignments-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 0.9rem;
        }

        .assignments-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #666;
        }

        .assignments-table tr:hover {
            background: #f8f9ff;
        }

        .curve-chart {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            gap: 4ex;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            background: white;
        }

        .chart-canvas {
            position: relative;
            width: 100%;
            height: 350px;
            background: #fafafa;
            border-radius: 5px;
            overflow: hidden;
        }

        .chart-axis {
            position: absolute;
            color: #666;
            font-size: 0.8rem;
        }

        .chart-axis.x-axis {
            bottom: -20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 30px;
        }

        .chart-axis.y-axis {
            left: -25px;
            top: 0;
            bottom: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            text-align: right;
            padding: 10px 0;
        }

        .chart-line {
            position: absolute;
            pointer-events: none;
        }

        .chart-line.target-line {
            border-top: 3px solid #667eea;
            z-index: 2;
        }

        .chart-line.actual-line {
            border-top: 3px solid #dc3545;
            z-index: 3;
        }

        .chart-point {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 4;
            transition: all 0.3s ease;
        }

        .chart-point:hover {
            transform: scale(1.5);
        }

        .chart-point.target-point {
            background: #667eea;
            border: 2px solid white;
        }

        .chart-point.actual-point {
            background: #dc3545;
            border: 2px solid white;
        }

        .chart-bars-time {
            position: absolute;
            bottom: 20px;
            left: 30px;
            right: 30px;
            height: 320px;
            display: flex;
            align-items: end;
            gap: 2px;
        }

        .time-bar {
            flex: 1;
            min-height: 2px;
            border-radius: 2px 2px 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .time-bar:hover {
            opacity: 0.8;
        }

        .time-bar.target-bar {
            background: linear-gradient(180deg, #667eea, #764ba2);
            margin-right: 1px;
        }

        .time-bar.actual-bar {
            background: linear-gradient(180deg, #dc3545, #fd7e14);
        }

        .chart-grid {
            position: absolute;
            top: 20px;
            left: 30px;
            right: 30px;
            bottom: 20px;
            pointer-events: none;
        }

        .grid-line {
            position: absolute;
            border-top: 1px solid #e9ecef;
            width: 100%;
        }

        .chart-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 12px;
            border-radius: 5px;
            font-size: 0.8rem;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 250px;
            line-height: 1.4;
        }

        .chart-bars {
            display: flex;
            align-items: end;
            height: 300px;
            gap: 5px;
            padding: 20px 0;
        }

        .chart-bar {
            flex: 1;
            background: linear-gradient(180deg, #667eea, #764ba2);
            border-radius: 3px 3px 0 0;
            min-height: 5px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chart-bar:hover {
            opacity: 0.8;
            transform: translateY(-2px);
        }

        .chart-bar.cost-bar {
            background: linear-gradient(180deg, #28a745, #20c997);
        }

        .chart-bar.actual-bar {
            background: linear-gradient(180deg, #dc3545, #fd7e14);
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        .chart-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.8rem;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .utilization-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .utilization-card {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .utilization-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .utilization-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
        }

        .metric-label {
            color: #666;
        }

        .metric-value {
            font-weight: bold;
            color: #333;
        }

        .assignment-detail {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 3px solid #667eea;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .integrity-actions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .integrity-results {
            margin-top: 20px;
        }

        .dcma-point {
            background: white;
            border-radius: 10px;
            margin: 15px 0;
            padding: 20px;
            border-left: 5px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .dcma-point.pass {
            border-left-color: #28a745;
            background: #f8fff9;
        }

        .dcma-point.fail {
            border-left-color: #dc3545;
            background: #fff8f8;
        }

        .dcma-point.warning {
            border-left-color: #ffc107;
            background: #fffdf5;
        }

        .dcma-point h4 {
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dcma-point h4:hover {
            color: #667eea;
        }

        .dcma-expand-icon {
            margin-left: auto;
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .dcma-expand-icon.expanded {
            transform: rotate(180deg);
        }

        .dcma-summary {
            margin-bottom: 15px;
        }

        .dcma-expandable {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
        }

        .dcma-expandable.expanded {
            max-height: 2000px; /* Increased from 500px to accommodate large tables */
        }

        .dcma-expandable-content {
            padding-top: 15px;
            border-top: 2px solid rgba(102, 126, 234, 0.1);
            margin-top: 15px;
        }

        .dcma-status {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .dcma-status.pass {
            color: #28a745;
        }

        .dcma-status.fail {
            color: #dc3545;
        }

        .dcma-status.warning {
            color: #fd7e14;
        }

        .dcma-details {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .dcma-metric {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 5px;
        }

        .dcma-metric strong {
            color: #333;
        }

        .integrity-summary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .summary-score {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .summary-grade {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .summary-breakdown {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .breakdown-item {
            text-align: center;
        }

        .breakdown-count {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .breakdown-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .dcma-recommendations {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin: 15px 0;
        }

        .dcma-recommendations h5 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .dcma-recommendations ul {
            margin: 10px 0 0 20px;
            padding: 0;
        }

        .dcma-recommendations li {
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .dcma-impact {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .dcma-impact.high-impact {
            background: #fff0f0;
            border-left: 4px solid #dc3545;
        }

        .dcma-impact.medium-impact {
            background: #fffaf0;
            border-left: 4px solid #ffc107;
        }

        .dcma-impact h5 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .dcma-details h5 {
            margin: 15px 0 10px 0;
            color: #333;
            font-size: 1rem;
        }

        .failed-items-section {
            background: #fff8f0;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            display: block;
            position: relative;
            z-index: 1;
            max-height: 500px;
            overflow-y: auto;
        }

        .failed-items-section h5 {
            margin: 0 0 15px 0;
            color: #856404;
        }

        .failed-items-table {
            margin-bottom: 20px;
            display: block;
            width: 100%;
        }

        .failed-items-table h6 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 0.95rem;
            font-weight: bold;
            display: block;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            display: block;
            width: 100%;
            margin: 10px 0;
        }

        .integrity-items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            background: white;
            display: table;
            table-layout: auto;
        }

        .integrity-items-table th {
            background: #f8f9fa;
            padding: 8px 12px;
            text-align: left;
            font-weight: bold;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }

        .integrity-items-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: top;
            word-wrap: break-word;
            max-width: 200px;
        }

        .integrity-items-table tbody {
            display: table-row-group;
        }

        .integrity-items-table tr {
            display: table-row;
        }

        .integrity-items-table tr:hover {
            background: #f8f9ff;
        }

        .integrity-items-table small {
            color: #6c757d;
            font-size: 0.8em;
        }

        .table-note {
            margin: 10px 0 0 0;
            font-size: 0.8rem;
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Schedulytics</h1>
            <p>Upload and analyze Primavera P6 XER files directly in your browser</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">📁</div>
                <div class="upload-text">
                    <strong>Drop your XER file here or click to browse</strong><br>
                    <small>Supports .xer files from Primavera P6</small>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".xer">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    Choose File
                </button>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <div>Parsing XER file...</div>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="results" class="results">
            <div class="tabs">
                <button class="tab active" onclick="showTab('overview')">📊 Overview</button>
                <button class="tab" onclick="showTab('activities')">📋 Activities</button>
                <button class="tab" onclick="showTab('critical')">🚨 Critical Path</button>
                <button class="tab" onclick="showTab('resources')">👥 Resources</button>
                <button class="tab" onclick="showTab('assignments')">🔗 Assignments</button>
                <button class="tab" onclick="showTab('curves')">📈 Resource Curves</button>
                <button class="tab" onclick="showTab('integrity')">✅ Integrity Check</button>
                <button class="tab" onclick="showTab('export')">💾 Export</button>
            </div>

            <div class="tab-content">
                <div id="overview" class="tab-pane active">
                    <div id="projectInfo" class="project-info"></div>
                    <div id="statsGrid" class="stats-grid"></div>
                    <div id="statusBreakdown"></div>
                </div>

                <div id="activities" class="tab-pane">
                    <div class="filters" id="activityFilters">
                        <div class="filter-group">
                            <label>Status:</label>
                            <select id="statusFilter" onchange="filterActivities()">
                                <option value="">All</option>
                                <option value="TK_NotStart">Not Started</option>
                                <option value="TK_Active">Active</option>
                                <option value="TK_Complete">Complete</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Min Duration (hrs):</label>
                            <input type="number" id="minDurationFilter" min="0" onchange="filterActivities()">
                        </div>
                        <div class="filter-group">
                            <label>Max Duration (hrs):</label>
                            <input type="number" id="maxDurationFilter" min="0" onchange="filterActivities()">
                        </div>
                        <div class="filter-group">
                            <label>Activity Name:</label>
                            <input type="text" id="nameFilter" placeholder="Search..." onchange="filterActivities()">
                        </div>
                    </div>
                    <div id="activitiesTable"></div>
                </div>

                <div id="critical" class="tab-pane">
                    <div id="criticalPathInfo"></div>
                    <div id="criticalActivitiesTable"></div>
                </div>

                <div id="resources" class="tab-pane">
                    <div id="resourceStats"></div>
                    <div id="resourcesList"></div>
                </div>

                <div id="assignments" class="tab-pane">
                    <div id="assignmentStats"></div>
                    <div class="filters" id="assignmentFilters">
                        <div class="filter-group">
                            <label>Resource:</label>
                            <select id="resourceAssignmentFilter" onchange="filterAssignments()">
                                <option value="">All Resources</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Activity:</label>
                            <input type="text" id="activityAssignmentFilter" placeholder="Search activities..." onchange="filterAssignments()">
                        </div>
                        <div class="filter-group">
                            <label>Min Cost:</label>
                            <input type="number" id="minCostFilter" min="0" onchange="filterAssignments()">
                        </div>
                    </div>
                    <div id="assignmentsTable"></div>
                </div>

                <div id="curves" class="tab-pane">
                    <div class="filters" id="curveFilters">
                        <div class="filter-group">
                            <label>Select Resource:</label>
                            <select id="resourceCurveFilter" onchange="showResourceCurve()">
                                <option value="">Choose a resource...</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Chart Type:</label>
                            <select id="chartTypeFilter" onchange="showResourceCurve()">
                                <option value="quantity">Quantity</option>
                                <option value="cost">Cost</option>
                                <option value="both">Both</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Export:</label>
                            <div>
                                <button class="export-btn" onclick="exportResourceCurveCSV()" title="Export current resource curve data">📊 Export Curve (CSV)</button>
                                <button class="export-btn" onclick="exportAllResourceCurvesCSV()" title="Export all resource curves data">📈 Export All Curves (CSV)</button>
                                <button class="export-btn" onclick="exportResourceUtilizationJSON()" title="Export resource utilization summary">📋 Export Utilization (JSON)</button>
                            </div>
                        </div>
                    </div>
                    <div id="resourceCurveDisplay"></div>
                </div>

                <div id="integrity" class="tab-pane">
                    <div class="project-info">
                        <h3>✅ DCMA 14-Point Schedule Integrity Assessment</h3>
                        <p>This assessment evaluates your schedule against the Defense Contract Management Agency's 14-point assessment criteria for schedule quality and integrity.</p>
                    </div>
                    
                    <div class="integrity-actions">
                        <button class="upload-btn" onclick="performIntegrityCheck()" id="integrityCheckBtn">
                            🔍 Run Integrity Check
                        </button>
                        <button class="export-btn" onclick="exportIntegrityReportCSV()" id="exportIntegrityBtn" style="display: none;">
                            📊 Export Report (CSV)
                        </button>
                        <button class="export-btn" onclick="exportIntegrityReportJSON()" id="exportIntegrityJSONBtn" style="display: none;">
                            📋 Export Report (JSON)
                        </button>
                    </div>
                    
                    <div id="integrityResults" class="integrity-results"></div>
                </div>

                <div id="export" class="tab-pane">
                    <div class="export-section">
                        <h3>Export Options</h3>
                        <p>Download your project data in various formats:</p>
                        <br>
                        <h4>📊 Activities & Schedule</h4>
                        <button class="export-btn" onclick="exportActivitiesCSV()">📄 Export Activities (CSV)</button>
                        <button class="export-btn" onclick="exportCriticalPathCSV()">🚨 Export Critical Path (CSV)</button>
                        <br><br>
                        <h4>👥 Resources & Curves</h4>
                        <button class="export-btn" onclick="exportResourcesCSV()">👥 Export Resources (CSV)</button>
                        <button class="export-btn" onclick="exportResourceCurveCSV()">📊 Export Current Resource Curve (CSV)</button>
                        <button class="export-btn" onclick="exportAllResourceCurvesCSV()">📈 Export All Resource Curves (CSV)</button>
                        <button class="export-btn" onclick="exportResourceUtilizationJSON()">📋 Export Resource Utilization (JSON)</button>
                        <br><br>
                        <h4>📋 Project Summary</h4>
                        <button class="export-btn" onclick="exportProjectJSON()">📋 Export Project Summary (JSON)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include P6XER-JS library -->
    <script src="./browser.js"></script>
    
    <script>
        let currentReader = null;
        let currentProject = null;
        let allActivities = [];
        let filteredActivities = [];
        let allAssignments = [];
        let filteredAssignments = [];
        let resourceUtilization = {};

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('dragleave', handleDragLeave);

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        async function processFile(file) {
            if (!file.name.toLowerCase().endsWith('.xer')) {
                showError('Please select a valid XER file.');
                return;
            }

            showLoading(true);
            hideError();

            try {
                const text = await file.text();
                
                // Parse XER content using P6XER-JS
                currentReader = new P6XERJS.Reader();
                currentReader.parseContent(text);
                
                if (currentReader.projects.length > 0) {
                    currentProject = currentReader.projects[0];
                    allActivities = currentReader.getActivitiesByProject(currentProject.proj_id);
                    filteredActivities = [...allActivities];
                    allAssignments = currentReader.activityResources || [];
                    filteredAssignments = [...allAssignments];
                    resourceUtilization = currentReader.getResourceUtilization();
                    
                    displayResults();
                    populateResourceFilters();
                    document.getElementById('results').style.display = 'block';
                    
                    showSuccess(`Successfully loaded project: ${currentProject.proj_name || currentProject.proj_short_name || 'Unnamed Project'}`);
                } else {
                    showError('No projects found in the XER file.');
                }
            } catch (error) {
                showError(`Error parsing XER file: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        function displayResults() {
            displayOverview();
            displayActivities();
            displayCriticalPath();
            displayResources();
            displayAssignments();
        }

        function displayOverview() {
            // Project information
            const projectInfo = document.getElementById('projectInfo');
            projectInfo.innerHTML = `
                <h3>📋 Project Information</h3>
                <p><strong>Name:</strong> ${currentProject.proj_name || 'Unnamed Project'}</p>
                <p><strong>Short Name:</strong> ${currentProject.proj_short_name || 'N/A'}</p>
                <p><strong>ID:</strong> ${currentProject.proj_id}</p>
                <p><strong>Manager:</strong> ${currentProject.proj_mgr || 'N/A'}</p>
                <p><strong>Status:</strong> ${currentProject.status_code || 'N/A'}</p>
            `;

            // Statistics
            const stats = currentReader.getSummaryStats();
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.totalActivities}</div>
                    <div class="stat-label">Total Activities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.totalResources}</div>
                    <div class="stat-label">Resources</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.totalRelationships}</div>
                    <div class="stat-label">Relationships</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.totalResourceAssignments || 0}</div>
                    <div class="stat-label">Resource Assignments</div>
                </div>
            `;

            // Status breakdown
            const statusCounts = {};
            allActivities.forEach(activity => {
                const status = activity.status_code || 'Unknown';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const statusBreakdown = document.getElementById('statusBreakdown');
            statusBreakdown.innerHTML = `
                <h3>📈 Activity Status Breakdown</h3>
                <div class="stats-grid">
                    ${Object.entries(statusCounts).map(([status, count]) => `
                        <div class="stat-card">
                            <div class="stat-value">${count}</div>
                            <div class="stat-label">${getStatusLabel(status)}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function displayActivities() {
            updateActivitiesTable();
        }

        function displayCriticalPath() {
            const criticalActivities = currentReader.getCriticalActivities();
            
            const criticalPathInfo = document.getElementById('criticalPathInfo');
            criticalPathInfo.innerHTML = `
                <div class="project-info">
                    <h3>🚨 Critical Path Analysis</h3>
                    <p><strong>Total Activities:</strong> ${allActivities.length}</p>
                    <p><strong>Critical Activities:</strong> ${criticalActivities.length}</p>
                    <p><strong>Percentage Critical:</strong> ${((criticalActivities.length / allActivities.length) * 100).toFixed(1)}%</p>
                </div>
            `;

            const criticalTable = document.getElementById('criticalActivitiesTable');
            criticalTable.innerHTML = createActivitiesTable(criticalActivities, true);
        }

        function displayResources() {
            const resourceTypes = {};
            currentReader.resources.forEach(resource => {
                const type = resource.rsrc_type || 'Unknown';
                resourceTypes[type] = (resourceTypes[type] || 0) + 1;
            });

            const resourceStats = document.getElementById('resourceStats');
            resourceStats.innerHTML = `
                <div class="project-info">
                    <h3>👥 Resource Summary</h3>
                    <p><strong>Total Resources:</strong> ${currentReader.resources.length}</p>
                    ${Object.entries(resourceTypes).map(([type, count]) => 
                        `<p><strong>${getResourceTypeLabel(type)}:</strong> ${count}</p>`
                    ).join('')}
                </div>
            `;

            const resourcesList = document.getElementById('resourcesList');
            resourcesList.innerHTML = `
                <div class="resource-list">
                    ${currentReader.resources.map(resource => `
                        <div class="resource-card">
                            <div class="resource-name">${resource.rsrc_name}</div>
                            <div class="resource-type">${getResourceTypeLabel(resource.rsrc_type)}</div>
                            <div style="font-size: 0.8rem; color: #999;">ID: ${resource.rsrc_id}</div>
                        </div>
                    `).join('')}
                </div>
                ${currentReader.resources.length > 20 ? '<p style="margin-top: 20px; color: #666;">Showing first 20 resources...</p>' : ''}
            `;
        }

        function displayAssignments() {
            const assignmentStats = document.getElementById('assignmentStats');
            const totalAssignments = allAssignments.length;
            const totalCost = allAssignments.reduce((sum, a) => sum + (parseFloat(a.target_cost) || 0), 0);
            const totalActualCost = allAssignments.reduce((sum, a) => sum + (parseFloat(a.act_reg_cost) || 0) + (parseFloat(a.act_ot_cost) || 0), 0);
            
            assignmentStats.innerHTML = `
                <div class="project-info">
                    <h3>🔗 Resource Assignment Summary</h3>
                    <p><strong>Total Assignments:</strong> ${totalAssignments}</p>
                    <p><strong>Total Target Cost:</strong> $${totalCost.toLocaleString()}</p>
                    <p><strong>Total Actual Cost:</strong> $${totalActualCost.toLocaleString()}</p>
                    <p><strong>Cost Variance:</strong> $${(totalActualCost - totalCost).toLocaleString()}</p>
                </div>
            `;
            
            updateAssignmentsTable();
        }

        function displayResourceUtilization() {
            const utilizationContainer = document.getElementById('resourceCurveDisplay');
            const topResources = Object.values(resourceUtilization)
                .sort((a, b) => b.totalTargetCost - a.totalTargetCost)
                .slice(0, 10);
            
            utilizationContainer.innerHTML = `
                <div class="utilization-summary">
                    ${topResources.map(util => `
                        <div class="utilization-card">
                            <div class="utilization-header">${util.resource ? util.resource.rsrc_name : 'Unknown Resource'}</div>
                            <div class="utilization-metrics">
                                <span class="metric-label">Assignments:</span>
                                <span class="metric-value">${util.assignmentCount}</span>
                                <span class="metric-label">Target Qty:</span>
                                <span class="metric-value">${util.totalTargetQty.toFixed(1)}</span>
                                <span class="metric-label">Actual Qty:</span>
                                <span class="metric-value">${util.totalActualQty.toFixed(1)}</span>
                                <span class="metric-label">Target Cost:</span>
                                <span class="metric-value">$${util.totalTargetCost.toLocaleString()}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function populateResourceFilters() {
            // Populate assignment resource filter
            const resourceFilter = document.getElementById('resourceAssignmentFilter');
            resourceFilter.innerHTML = '<option value="">All Resources</option>';
            
            currentReader.resources.forEach(resource => {
                const option = document.createElement('option');
                option.value = resource.rsrc_id;
                option.textContent = resource.rsrc_name;
                resourceFilter.appendChild(option);
            });

            // Populate curve resource filter
            const curveFilter = document.getElementById('resourceCurveFilter');
            curveFilter.innerHTML = '<option value="">Choose a resource...</option>';
            
            Object.keys(resourceUtilization).forEach(resourceId => {
                const util = resourceUtilization[resourceId];
                const option = document.createElement('option');
                option.value = resourceId;
                option.textContent = util.resource ? util.resource.rsrc_name : resourceId;
                curveFilter.appendChild(option);
            });
        }

        function filterAssignments() {
            const resourceFilter = document.getElementById('resourceAssignmentFilter').value;
            const activityFilter = document.getElementById('activityAssignmentFilter').value.toLowerCase();
            const minCostFilter = parseFloat(document.getElementById('minCostFilter').value) || 0;

            filteredAssignments = allAssignments.filter(assignment => {
                const matchesResource = !resourceFilter || assignment.rsrc_id === resourceFilter;
                const matchesCost = (parseFloat(assignment.target_cost) || 0) >= minCostFilter;
                
                let matchesActivity = true;
                if (activityFilter) {
                    const activity = allActivities.find(a => a.task_id === assignment.task_id);
                    matchesActivity = activity && (
                        activity.task_name.toLowerCase().includes(activityFilter) ||
                        activity.task_code.toLowerCase().includes(activityFilter)
                    );
                }

                return matchesResource && matchesCost && matchesActivity;
            });

            updateAssignmentsTable();
        }

        function updateAssignmentsTable() {
            const assignmentsTable = document.getElementById('assignmentsTable');
            if (filteredAssignments.length === 0) {
                assignmentsTable.innerHTML = '<p>No assignments to display.</p>';
                return;
            }

            assignmentsTable.innerHTML = `
                <p>Showing ${filteredAssignments.length} assignments</p>
                <table class="assignments-table">
                    <thead>
                        <tr>
                            <th>Resource</th>
                            <th>Activity</th>
                            <th>Target Qty</th>
                            <th>Actual Qty</th>
                            <th>Target Cost</th>
                            <th>Actual Cost</th>
                            <th>Remaining</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredAssignments.map(assignment => {
                            const resource = currentReader.resources.find(r => r.rsrc_id === assignment.rsrc_id);
                            const activity = allActivities.find(a => a.task_id === assignment.task_id);
                            const actualQty = (parseFloat(assignment.act_reg_qty) || 0) + (parseFloat(assignment.act_ot_qty) || 0);
                            const actualCost = (parseFloat(assignment.act_reg_cost) || 0) + (parseFloat(assignment.act_ot_cost) || 0);
                            
                            return `
                                <tr>
                                    <td><strong>${resource ? resource.rsrc_name : 'Unknown'}</strong></td>
                                    <td>${activity ? activity.task_name : 'Unknown Activity'}<br>
                                        <small style="color: #666;">${activity ? activity.task_code : ''}</small></td>
                                    <td>${(parseFloat(assignment.target_qty) || 0).toFixed(1)}</td>
                                    <td>${actualQty.toFixed(1)}</td>
                                    <td>$${(parseFloat(assignment.target_cost) || 0).toLocaleString()}</td>
                                    <td>$${actualCost.toLocaleString()}</td>
                                    <td>${(parseFloat(assignment.remain_qty) || 0).toFixed(1)}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function showResourceCurve() {
            const resourceId = document.getElementById('resourceCurveFilter').value;
            const chartType = document.getElementById('chartTypeFilter').value;
            
            if (!resourceId) {
                displayResourceUtilization();
                return;
            }
            
            const curve = currentReader.getResourceCurve(resourceId);
            const curveDisplay = document.getElementById('resourceCurveDisplay');
            
            if (!curve.timeBasedData || curve.timeBasedData.length === 0) {
                curveDisplay.innerHTML = `
                    <div class="no-data">
                        <h3>No time-based data available for ${curve.resource ? curve.resource.rsrc_name : 'this resource'}</h3>
                        <p>Activities may be missing date information.</p>
                    </div>
                `;
                return;
            }
            
            // Prepare data for visualization
            const timeData = curve.timeBasedData;
            const maxTargetQty = Math.max(...timeData.map(d => d.weeklyTargetQty));
            const maxActualQty = Math.max(...timeData.map(d => d.weeklyActualQty));
            const maxTargetCost = Math.max(...timeData.map(d => d.weeklyTargetCost));
            const maxActualCost = Math.max(...timeData.map(d => d.weeklyActualCost));
            
            let maxValue = 0;
            let valueLabel = '';
            let targetValues = [];
            let actualValues = [];
            
            if (chartType === 'quantity') {
                maxValue = Math.max(maxTargetQty, maxActualQty);
                valueLabel = 'Quantity';
                targetValues = timeData.map(d => d.weeklyTargetQty);
                actualValues = timeData.map(d => d.weeklyActualQty);
            } else if (chartType === 'cost') {
                maxValue = Math.max(maxTargetCost, maxActualCost);
                valueLabel = 'Cost ($)';
                targetValues = timeData.map(d => d.weeklyTargetCost);
                actualValues = timeData.map(d => d.weeklyActualCost);
            } else {
                maxValue = Math.max(maxTargetCost, maxActualCost);
                valueLabel = 'Cost ($)';
                targetValues = timeData.map(d => d.weeklyTargetCost);
                actualValues = timeData.map(d => d.weeklyActualCost);
            }
            
            curveDisplay.innerHTML = `
                <div class="assignment-detail">
                    <h3>📈 Resource Curve: ${curve.resource ? curve.resource.rsrc_name : 'Unknown Resource'}</h3>
                    <p><strong>Resource Type:</strong> ${getResourceTypeLabel(curve.resource ? curve.resource.rsrc_type : '')}</p>
                    <p><strong>Time Period:</strong> ${timeData.length} weeks</p>
                    <p><strong>Peak ${valueLabel}:</strong> ${maxValue.toFixed(2)} ${chartType === 'cost' ? '$' : 'units'}</p>
                </div>
                
                <div class="curve-chart">
                    <h4>${valueLabel} Over Time</h4>
                    <div class="chart-container">
                        <div class="chart-canvas" id="chartCanvas">
                            <div class="chart-grid" id="chartGrid"></div>
                            <div class="chart-bars-time" id="chartBarsTime"></div>
                            <div class="chart-tooltip" id="chartTooltip"></div>
                        </div>
                        <div class="chart-axis y-axis" id="yAxis"></div>
                        <div class="chart-axis x-axis" id="xAxis"></div>
                    </div>
                    
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: linear-gradient(135deg, #667eea, #764ba2);"></div>
                            <span>Target ${valueLabel}</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: linear-gradient(135deg, #dc3545, #fd7e14);"></div>
                            <span>Actual ${valueLabel}</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>📊 Weekly Breakdown</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="assignments-table">
                            <thead>
                                <tr>
                                    <th>Week Starting</th>
                                    <th>Target ${chartType === 'quantity' ? 'Qty' : 'Cost'}</th>
                                    <th>Actual ${chartType === 'quantity' ? 'Qty' : 'Cost'}</th>
                                    <th>Variance</th>
                                    <th>Active Activities</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${timeData.map((week, index) => {
                                    const targetVal = chartType === 'quantity' ? week.weeklyTargetQty : week.weeklyTargetCost;
                                    const actualVal = chartType === 'quantity' ? week.weeklyActualQty : week.weeklyActualCost;
                                    const variance = actualVal - targetVal;
                                    const varianceClass = variance > 0 ? 'style="color: #dc3545;"' : variance < 0 ? 'style="color: #28a745;"' : '';
                                    
                                    return `
                                        <tr>
                                            <td><strong>${week.date.toLocaleDateString()}</strong></td>
                                            <td>${chartType === 'cost' ? '$' : ''}${targetVal.toFixed(2)}</td>
                                            <td>${chartType === 'cost' ? '$' : ''}${actualVal.toFixed(2)}</td>
                                            <td ${varianceClass}>${chartType === 'cost' ? '$' : ''}${variance.toFixed(2)}</td>
                                            <td>${week.activeActivities.length} activities</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Render the chart
            renderTimeChart(timeData, targetValues, actualValues, maxValue, chartType);
        }

        function renderTimeChart(timeData, targetValues, actualValues, maxValue, chartType) {
            const chartBars = document.getElementById('chartBarsTime');
            const yAxis = document.getElementById('yAxis');
            const xAxis = document.getElementById('xAxis');
            const chartGrid = document.getElementById('chartGrid');
            const tooltip = document.getElementById('chartTooltip');
            
            if (!chartBars || !yAxis || !xAxis) return;
            
            // Clear existing content
            chartBars.innerHTML = '';
            yAxis.innerHTML = '';
            xAxis.innerHTML = '';
            chartGrid.innerHTML = '';
            
            // Create Y-axis labels and grid lines
            const steps = 5;
            for (let i = 0; i <= steps; i++) {
                const value = (maxValue / steps) * (steps - i);
                const yPos = (i / steps) * 100;
                
                // Y-axis label
                const label = document.createElement('div');
                label.textContent = chartType === 'cost' ? '$' + value.toFixed(0) : value.toFixed(1);
                label.style.position = 'absolute';
                label.style.top = yPos + '%';
                label.style.transform = 'translateY(-50%)';
                yAxis.appendChild(label);
                
                // Grid line
                if (i < steps) {
                    const gridLine = document.createElement('div');
                    gridLine.className = 'grid-line';
                    gridLine.style.top = yPos + '%';
                    chartGrid.appendChild(gridLine);
                }
            }
            
            // Create X-axis labels (show every few weeks to avoid crowding)
            const labelInterval = Math.max(1, Math.floor(timeData.length / 8));
            timeData.forEach((week, index) => {
                if (index % labelInterval === 0 || index === timeData.length - 1) {
                    const label = document.createElement('div');
                    label.textContent = week.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    label.style.position = 'absolute';
                    label.style.left = (index / (timeData.length - 1)) * 100 + '%';
                    label.style.transform = 'translateX(-50%)';
                    xAxis.appendChild(label);
                }
            });
            
            // Create bars
            timeData.forEach((week, index) => {
                const targetValue = targetValues[index];
                const actualValue = actualValues[index];
                
                const targetHeight = maxValue > 0 ? (targetValue / maxValue) * 100 : 0;
                const actualHeight = maxValue > 0 ? (actualValue / maxValue) * 100 : 0;
                
                // Target bar
                const targetBar = document.createElement('div');
                targetBar.className = 'time-bar target-bar';
                targetBar.style.height = targetHeight + '%';
                
                // Actual bar
                const actualBar = document.createElement('div');
                actualBar.className = 'time-bar actual-bar';
                actualBar.style.height = actualHeight + '%';
                
                // Add hover effects
                const showTooltip = (e) => {
                    const variance = actualValue - targetValue;
                    const varianceText = variance >= 0 ? '+' + variance.toFixed(2) : variance.toFixed(2);
                    
                    tooltip.innerHTML = `
                        <strong>Week of ${week.date.toLocaleDateString()}</strong><br>
                        Target: ${chartType === 'cost' ? '$' : ''}${targetValue.toFixed(2)}<br>
                        Actual: ${chartType === 'cost' ? '$' : ''}${actualValue.toFixed(2)}<br>
                        Variance: ${chartType === 'cost' ? '$' : ''}${varianceText}<br>
                        Active Activities: ${week.activeActivities.length}
                    `;
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY - 10 + 'px';
                    tooltip.style.opacity = '1';
                };
                
                const hideTooltip = () => {
                    tooltip.style.opacity = '0';
                };
                
                targetBar.addEventListener('mouseenter', showTooltip);
                targetBar.addEventListener('mouseleave', hideTooltip);
                actualBar.addEventListener('mouseenter', showTooltip);
                actualBar.addEventListener('mouseleave', hideTooltip);
                
                chartBars.appendChild(targetBar);
                chartBars.appendChild(actualBar);
            });
        }

        function createActivitiesTable(activities, highlightCritical = false) {
            if (activities.length === 0) {
                return '<p>No activities to display.</p>';
            }

            return `
                <p>Showing ${activities.length} activities</p>
                <table class="activities-table">
                    <thead>
                        <tr>
                            <th>Task Code</th>
                            <th>Task Name</th>
                            <th>Status</th>
                            <th>Duration (hrs)</th>
                            <th>% Complete</th>
                            <th>Float (hrs)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${activities.map(activity => {
                            const isCritical = highlightCritical && (activity.total_float_hr_cnt === 0 || activity.driving_path_flag === 'Y');
                            return `
                                <tr ${isCritical ? 'class="critical-activity"' : ''}>
                                    <td><strong>${activity.task_code}</strong></td>
                                    <td>${activity.task_name}</td>
                                    <td><span class="status-badge ${getStatusClass(activity.status_code)}">${getStatusLabel(activity.status_code)}</span></td>
                                    <td>${activity.target_drtn_hr_cnt || 0}</td>
                                    <td>${activity.phys_complete_pct || 0}%</td>
                                    <td>${activity.total_float_hr_cnt || 0}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function filterActivities() {
            const statusFilter = document.getElementById('statusFilter').value;
            const minDurationFilter = parseInt(document.getElementById('minDurationFilter').value) || 0;
            const maxDurationFilter = parseInt(document.getElementById('maxDurationFilter').value) || Infinity;
            const nameFilter = document.getElementById('nameFilter').value.toLowerCase();

            filteredActivities = allActivities.filter(activity => {
                const matchesStatus = !statusFilter || activity.status_code === statusFilter;
                const matchesDuration = (activity.target_drtn_hr_cnt || 0) >= minDurationFilter && 
                                      (activity.target_drtn_hr_cnt || 0) <= maxDurationFilter;
                const matchesName = !nameFilter || 
                                  activity.task_name.toLowerCase().includes(nameFilter) ||
                                  activity.task_code.toLowerCase().includes(nameFilter);

                return matchesStatus && matchesDuration && matchesName;
            });

            updateActivitiesTable();
        }

        function updateActivitiesTable() {
            const activitiesTable = document.getElementById('activitiesTable');
            activitiesTable.innerHTML = createActivitiesTable(filteredActivities);
        }

        function showTab(tabName) {
            // Hide all tab panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab pane
            document.getElementById(tabName).classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function showSuccess(message) {
            // Create and show success message
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(successDiv, document.getElementById('results'));
            
            // Remove after 5 seconds
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }

        function getStatusLabel(status) {
            const labels = {
                'TK_NotStart': 'Not Started',
                'TK_Active': 'Active',
                'TK_Complete': 'Complete',
                'Unknown': 'Unknown'
            };
            return labels[status] || status;
        }

        function getStatusClass(status) {
            const classes = {
                'TK_NotStart': 'status-not-started',
                'TK_Active': 'status-active',
                'TK_Complete': 'status-complete'
            };
            return classes[status] || '';
        }

        function getResourceTypeLabel(type) {
            const labels = {
                'RT_Labor': 'Labor',
                'RT_Mat': 'Material',
                'RT_Equip': 'Equipment',
                'RT_Expense': 'Expense',
                'Unknown': 'Unknown'
            };
            return labels[type] || type;
        }

        // Export functions
        function exportResourceCurveCSV() {
            const resourceId = document.getElementById('resourceCurveFilter').value;
            const chartType = document.getElementById('chartTypeFilter').value;
            
            if (!resourceId) {
                showError('Please select a resource to export its curve data.');
                return;
            }
            
            const curve = currentReader.getResourceCurve(resourceId);
            const resource = curve.resource;
            
            if (!curve.timeBasedData || curve.timeBasedData.length === 0) {
                showError('No time-based data available for the selected resource.');
                return;
            }
            
            const csvData = curve.timeBasedData.map(week => ({
                'Week Start': week.date.toISOString().split('T')[0],
                'Week End': week.weekEnd.toISOString().split('T')[0],
                'Target Quantity': week.weeklyTargetQty.toFixed(2),
                'Actual Quantity': week.weeklyActualQty.toFixed(2),
                'Target Cost': week.weeklyTargetCost.toFixed(2),
                'Actual Cost': week.weeklyActualCost.toFixed(2),
                'Active Activities': week.activeActivities.length,
                'Quantity Variance': (week.weeklyActualQty - week.weeklyTargetQty).toFixed(2),
                'Cost Variance': (week.weeklyActualCost - week.weeklyTargetCost).toFixed(2)
            }));
            
            const csv = generateCSV(csvData, [
                { key: 'Week Start', label: 'Week Start' },
                { key: 'Week End', label: 'Week End' },
                { key: 'Target Quantity', label: 'Target Quantity' },
                { key: 'Actual Quantity', label: 'Actual Quantity' },
                { key: 'Target Cost', label: 'Target Cost' },
                { key: 'Actual Cost', label: 'Actual Cost' },
                { key: 'Active Activities', label: 'Active Activities' },
                { key: 'Quantity Variance', label: 'Quantity Variance' },
                { key: 'Cost Variance', label: 'Cost Variance' }
            ]);
            
            const resourceName = resource ? resource.rsrc_name.replace(/[^a-zA-Z0-9]/g, '_') : 'resource';
            downloadFile(csv, `resource_curve_${resourceName}.csv`, 'text/csv');
        }

        function exportAllResourceCurvesCSV() {
            if (!currentReader || Object.keys(resourceUtilization).length === 0) {
                showError('No resource data available to export.');
                return;
            }
            
            const allCurveData = [];
            
            Object.keys(resourceUtilization).forEach(resourceId => {
                const curve = currentReader.getResourceCurve(resourceId);
                const resource = curve.resource;
                
                if (curve.timeBasedData && curve.timeBasedData.length > 0) {
                    curve.timeBasedData.forEach(week => {
                        allCurveData.push({
                            'Resource ID': resourceId,
                            'Resource Name': resource ? resource.rsrc_name : 'Unknown',
                            'Resource Type': resource ? getResourceTypeLabel(resource.rsrc_type) : 'Unknown',
                            'Week Start': week.date.toISOString().split('T')[0],
                            'Week End': week.weekEnd.toISOString().split('T')[0],
                            'Target Quantity': week.weeklyTargetQty.toFixed(2),
                            'Actual Quantity': week.weeklyActualQty.toFixed(2),
                            'Target Cost': week.weeklyTargetCost.toFixed(2),
                            'Actual Cost': week.weeklyActualCost.toFixed(2),
                            'Active Activities': week.activeActivities.length,
                            'Quantity Variance': (week.weeklyActualQty - week.weeklyTargetQty).toFixed(2),
                            'Cost Variance': (week.weeklyActualCost - week.weeklyTargetCost).toFixed(2)
                        });
                    });
                }
            });
            
            if (allCurveData.length === 0) {
                showError('No time-based resource data available to export.');
                return;
            }
            
            const csv = generateCSV(allCurveData, [
                { key: 'Resource ID', label: 'Resource ID' },
                { key: 'Resource Name', label: 'Resource Name' },
                { key: 'Resource Type', label: 'Resource Type' },
                { key: 'Week Start', label: 'Week Start' },
                { key: 'Week End', label: 'Week End' },
                { key: 'Target Quantity', label: 'Target Quantity' },
                { key: 'Actual Quantity', label: 'Actual Quantity' },
                { key: 'Target Cost', label: 'Target Cost' },
                { key: 'Actual Cost', label: 'Actual Cost' },
                { key: 'Active Activities', label: 'Active Activities' },
                { key: 'Quantity Variance', label: 'Quantity Variance' },
                { key: 'Cost Variance', label: 'Cost Variance' }
            ]);
            
            downloadFile(csv, 'all_resource_curves.csv', 'text/csv');
        }

        function exportResourceUtilizationJSON() {
            if (!currentReader || Object.keys(resourceUtilization).length === 0) {
                showError('No resource utilization data available to export.');
                return;
            }
            
            const utilizationSummary = {};
            
            Object.keys(resourceUtilization).forEach(resourceId => {
                const util = resourceUtilization[resourceId];
                const curve = currentReader.getResourceCurve(resourceId);
                
                utilizationSummary[resourceId] = {
                    resource: {
                        id: resourceId,
                        name: util.resource ? util.resource.rsrc_name : 'Unknown',
                        type: util.resource ? util.resource.rsrc_type : 'Unknown',
                        typeLabel: util.resource ? getResourceTypeLabel(util.resource.rsrc_type) : 'Unknown'
                    },
                    summary: {
                        totalTargetQuantity: util.totalTargetQty,
                        totalActualQuantity: util.totalActualQty,
                        totalTargetCost: util.totalTargetCost,
                        totalActualCost: util.totalActualCost,
                        assignmentCount: util.assignmentCount,
                        quantityVariance: util.totalActualQty - util.totalTargetQty,
                        costVariance: util.totalActualCost - util.totalTargetCost,
                        quantityEfficiency: util.totalTargetQty > 0 ? (util.totalActualQty / util.totalTargetQty) * 100 : 0,
                        costEfficiency: util.totalTargetCost > 0 ? (util.totalActualCost / util.totalTargetCost) * 100 : 0
                    },
                    timeBasedData: curve.timeBasedData || [],
                    assignments: util.assignments.map(assignment => ({
                        taskId: assignment.task_id,
                        targetQuantity: parseFloat(assignment.target_qty) || 0,
                        actualQuantity: (parseFloat(assignment.act_reg_qty) || 0) + (parseFloat(assignment.act_ot_qty) || 0),
                        targetCost: parseFloat(assignment.target_cost) || 0,
                        actualCost: (parseFloat(assignment.act_reg_cost) || 0) + (parseFloat(assignment.act_ot_cost) || 0),
                        remainingQuantity: parseFloat(assignment.remain_qty) || 0,
                        remainingCost: parseFloat(assignment.remain_cost) || 0
                    }))
                };
            });
            
            const exportData = {
                project: {
                    name: currentProject.proj_name,
                    shortName: currentProject.proj_short_name,
                    id: currentProject.proj_id,
                    manager: currentProject.proj_mgr
                },
                resourceUtilization: utilizationSummary,
                statistics: {
                    totalResources: Object.keys(utilizationSummary).length,
                    totalAssignments: Object.values(utilizationSummary).reduce((sum, util) => sum + util.summary.assignmentCount, 0),
                    totalTargetCost: Object.values(utilizationSummary).reduce((sum, util) => sum + util.summary.totalTargetCost, 0),
                    totalActualCost: Object.values(utilizationSummary).reduce((sum, util) => sum + util.summary.totalActualCost, 0),
                    overallCostVariance: Object.values(utilizationSummary).reduce((sum, util) => sum + util.summary.costVariance, 0)
                },
                exportDate: new Date().toISOString()
            };
            
            const json = JSON.stringify(exportData, null, 2);
            downloadFile(json, 'resource_utilization.json', 'application/json');
        }

        function exportActivitiesCSV() {
            if (!allActivities.length) return;
            
            const csv = generateCSV(allActivities, [
                { key: 'task_code', label: 'Task Code' },
                { key: 'task_name', label: 'Task Name' },
                { key: 'status_code', label: 'Status' },
                { key: 'target_drtn_hr_cnt', label: 'Duration (hrs)' },
                { key: 'phys_complete_pct', label: '% Complete' },
                { key: 'total_float_hr_cnt', label: 'Float (hrs)' }
            ]);
            
            downloadFile(csv, 'activities.csv', 'text/csv');
        }

        function exportCriticalPathCSV() {
            const criticalActivities = currentReader.getCriticalActivities();
            if (!criticalActivities.length) return;
            
            const csv = generateCSV(criticalActivities, [
                { key: 'task_code', label: 'Task Code' },
                { key: 'task_name', label: 'Task Name' },
                { key: 'target_drtn_hr_cnt', label: 'Duration (hrs)' },
                { key: 'total_float_hr_cnt', label: 'Float (hrs)' }
            ]);
            
            downloadFile(csv, 'critical_path.csv', 'text/csv');
        }

        function exportResourcesCSV() {
            if (!currentReader.resources.length) return;
            
            const csv = generateCSV(currentReader.resources, [
                { key: 'rsrc_name', label: 'Resource Name' },
                { key: 'rsrc_type', label: 'Type' },
                { key: 'rsrc_id', label: 'ID' }
            ]);
            
            downloadFile(csv, 'resources.csv', 'text/csv');
        }

        function exportProjectJSON() {
            const exportData = {
                project: {
                    name: currentProject.proj_name,
                    shortName: currentProject.proj_short_name,
                    id: currentProject.proj_id,
                    manager: currentProject.proj_mgr
                },
                statistics: {
                    totalActivities: allActivities.length,
                    totalResources: currentReader.resources.length,
                    totalRelationships: currentReader.relationships.length,
                    criticalActivities: currentReader.getCriticalActivities().length
                },
                exportDate: new Date().toISOString()
            };
            
            const json = JSON.stringify(exportData, null, 2);
            downloadFile(json, 'project_summary.json', 'application/json');
        }

        function generateCSV(data, fields) {
            const headers = fields.map(f => f.label).join(',');
            const rows = data.map(item => 
                fields.map(f => {
                    const value = item[f.key] || '';
                    // Escape commas and quotes
                    return typeof value === 'string' && (value.includes(',') || value.includes('"')) 
                        ? `"${value.replace(/"/g, '""')}"` 
                        : value;
                }).join(',')
            );
            
            return [headers, ...rows].join('\n');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // DCMA 14-Point Integrity Check Functions
        let integrityCheckResults = null;

        function performIntegrityCheck() {
            if (!currentReader || !allActivities.length) {
                showError('No project data available for integrity check.');
                return;
            }

            showLoading(true);
            const btn = document.getElementById('integrityCheckBtn');
            btn.disabled = true;
            btn.textContent = '🔍 Running Check...';

            setTimeout(() => {
                try {
                    integrityCheckResults = runDCMA14Assessment();
                    displayIntegrityResults();
                    
                    // Show export buttons
                    document.getElementById('exportIntegrityBtn').style.display = 'inline-block';
                    document.getElementById('exportIntegrityJSONBtn').style.display = 'inline-block';
                } catch (error) {
                    showError(`Error during integrity check: ${error.message}`);
                } finally {
                    showLoading(false);
                    btn.disabled = false;
                    btn.textContent = '🔍 Run Integrity Check';
                }
            }, 500);
        }

        function runDCMA14Assessment() {
            const activities = allActivities;
            const relationships = currentReader.relationships || [];
            const resources = currentReader.resources || [];
            const assignments = currentReader.activityResources || [];

            const results = {
                points: [],
                summary: {
                    totalPoints: 14,
                    passedPoints: 0,
                    failedPoints: 0,
                    warningPoints: 0,
                    score: 0,
                    grade: 'F'
                }
            };

            // Point 1: Logic
            const point1 = checkLogic(activities, relationships);
            results.points.push(point1);

            // Point 2: Leads
            const point2 = checkLeads(relationships);
            results.points.push(point2);

            // Point 3: Lags
            const point3 = checkLags(relationships);
            results.points.push(point3);

            // Point 4: Relationship Types
            const point4 = checkRelationshipTypes(relationships);
            results.points.push(point4);

            // Point 5: Hard Constraints
            const point5 = checkHardConstraints(activities);
            results.points.push(point5);

            // Point 6: High Float
            const point6 = checkHighFloat(activities);
            results.points.push(point6);

            // Point 7: Negative Float
            const point7 = checkNegativeFloat(activities);
            results.points.push(point7);

            // Point 8: High Duration
            const point8 = checkHighDuration(activities);
            results.points.push(point8);

            // Point 9: Invalid Dates
            const point9 = checkInvalidDates(activities);
            results.points.push(point9);

            // Point 10: Resources
            const point10 = checkResources(activities, assignments);
            results.points.push(point10);

            // Point 11: Incomplete Activities
            const point11 = checkIncompleteActivities(activities);
            results.points.push(point11);

            // Point 12: Critical Path Test
            const point12 = checkCriticalPath(activities);
            results.points.push(point12);

            // Point 13: CD-1 (not applicable for all projects)
            const point13 = checkCD1();
            results.points.push(point13);

            // Point 14: CD-2/3/4 (not applicable for all projects)
            const point14 = checkCD234();
            results.points.push(point14);

            // Calculate summary
            results.points.forEach(point => {
                if (point.status === 'pass') results.summary.passedPoints++;
                else if (point.status === 'fail') results.summary.failedPoints++;
                else if (point.status === 'warning') results.summary.warningPoints++;
            });

            results.summary.score = Math.round((results.summary.passedPoints / results.summary.totalPoints) * 100);
            
            if (results.summary.score >= 90) results.summary.grade = 'A';
            else if (results.summary.score >= 80) results.summary.grade = 'B';
            else if (results.summary.score >= 70) results.summary.grade = 'C';
            else if (results.summary.score >= 60) results.summary.grade = 'D';
            else results.summary.grade = 'F';

            return results;
        }

        function checkLogic(activities, relationships) {
            const activitiesWithPred = new Set();
            const activitiesWithSucc = new Set();
            
            relationships.forEach(rel => {
                activitiesWithPred.add(rel.task_id);
                activitiesWithSucc.add(rel.pred_task_id);
            });

            const startMilestones = activities.filter(a => 
                !activitiesWithPred.has(a.task_id) && 
                (a.target_drtn_hr_cnt === 0 || !a.target_drtn_hr_cnt)
            );

            const finishMilestones = activities.filter(a => 
                !activitiesWithSucc.has(a.task_id) && 
                (a.target_drtn_hr_cnt === 0 || !a.target_drtn_hr_cnt)
            );

            const danglingActivities = activities.filter(a => 
                !activitiesWithPred.has(a.task_id) && !activitiesWithSucc.has(a.task_id)
            );

            const activitiesWithoutPred = activities.filter(a => 
                !activitiesWithPred.has(a.task_id) && 
                parseFloat(a.target_drtn_hr_cnt || 0) > 0
            );

            const activitiesWithoutSucc = activities.filter(a => 
                !activitiesWithSucc.has(a.task_id) && 
                parseFloat(a.target_drtn_hr_cnt || 0) > 0
            );

            const status = danglingActivities.length === 0 && startMilestones.length >= 1 && finishMilestones.length >= 1 ? 'pass' : 'fail';

            return {
                number: 1,
                title: 'Logic',
                description: 'All activities (excluding start/end milestones) should have at least one predecessor and one successor.',
                status: status,
                details: {
                    danglingActivities: danglingActivities.length,
                    startMilestones: startMilestones.length,
                    finishMilestones: finishMilestones.length,
                    totalActivities: activities.length,
                    activitiesWithoutPred: activitiesWithoutPred.length,
                    activitiesWithoutSucc: activitiesWithoutSucc.length
                },
                failedItems: {
                    danglingActivities: danglingActivities.slice(0, 50).map(a => ({
                        id: a.task_id,
                        code: a.task_code,
                        name: a.task_name,
                        duration: a.target_drtn_hr_cnt || 0
                    })),
                    activitiesWithoutPred: activitiesWithoutPred.slice(0, 25).map(a => ({
                        id: a.task_id,
                        code: a.task_code,
                        name: a.task_name,
                        duration: a.target_drtn_hr_cnt || 0
                    })),
                    activitiesWithoutSucc: activitiesWithoutSucc.slice(0, 25).map(a => ({
                        id: a.task_id,
                        code: a.task_code,
                        name: a.task_name,
                        duration: a.target_drtn_hr_cnt || 0
                    }))
                },
                message: status === 'pass' ? 
                    'All activities are properly linked with predecessors and successors.' : 
                    `Found ${danglingActivities.length} dangling activities that lack proper logic ties.`
            };
        }

        function checkLeads(relationships) {
            const leadRelationships = relationships.filter(rel => 
                rel.lag_hr_cnt && parseFloat(rel.lag_hr_cnt) < 0
            );

            const status = leadRelationships.length === 0 ? 'pass' : leadRelationships.length <= relationships.length * 0.05 ? 'warning' : 'fail';

            return {
                number: 2,
                title: 'Leads',
                description: 'Minimize use of lead time in relationships (should be < 5% of total relationships).',
                status: status,
                details: {
                    leadsCount: leadRelationships.length,
                    totalRelationships: relationships.length,
                    percentage: relationships.length > 0 ? (leadRelationships.length / relationships.length * 100).toFixed(1) : 0
                },
                failedItems: {
                    leadRelationships: leadRelationships.slice(0, 50).map(rel => {
                        const predActivity = allActivities.find(a => a.task_id === rel.pred_task_id);
                        const succActivity = allActivities.find(a => a.task_id === rel.task_id);
                        return {
                            id: rel.task_pred_id,
                            predCode: predActivity ? predActivity.task_code : rel.pred_task_id,
                            predName: predActivity ? predActivity.task_name : 'Unknown',
                            succCode: succActivity ? succActivity.task_code : rel.task_id,
                            succName: succActivity ? succActivity.task_name : 'Unknown',
                            lagHours: rel.lag_hr_cnt,
                            type: rel.pred_type || 'FS'
                        };
                    })
                },
                message: status === 'pass' ? 
                    'No lead relationships found.' : 
                    `${leadRelationships.length} lead relationships found (${((leadRelationships.length / relationships.length) * 100).toFixed(1)}% of total).`
            };
        }

        function checkLags(relationships) {
            const lagRelationships = relationships.filter(rel => 
                rel.lag_hr_cnt && parseFloat(rel.lag_hr_cnt) > 0
            );

            const status = lagRelationships.length <= relationships.length * 0.1 ? 'pass' : 'warning';

            return {
                number: 3,
                title: 'Lags',
                description: 'Minimize use of lag time in relationships (should be < 10% of total relationships).',
                status: status,
                details: {
                    lagsCount: lagRelationships.length,
                    totalRelationships: relationships.length,
                    percentage: relationships.length > 0 ? (lagRelationships.length / relationships.length * 100).toFixed(1) : 0
                },
                failedItems: {
                    lagRelationships: lagRelationships.slice(0, 50).map(rel => {
                        const predActivity = allActivities.find(a => a.task_id === rel.pred_task_id);
                        const succActivity = allActivities.find(a => a.task_id === rel.task_id);
                        return {
                            id: rel.task_pred_id,
                            predCode: predActivity ? predActivity.task_code : rel.pred_task_id,
                            predName: predActivity ? predActivity.task_name : 'Unknown',
                            succCode: succActivity ? succActivity.task_code : rel.task_id,
                            succName: succActivity ? succActivity.task_name : 'Unknown',
                            lagHours: rel.lag_hr_cnt,
                            lagDays: (parseFloat(rel.lag_hr_cnt) / 8).toFixed(1),
                            type: rel.pred_type || 'FS'
                        };
                    })
                },
                message: status === 'pass' ? 
                    'Lag usage is within acceptable limits.' : 
                    `${lagRelationships.length} lag relationships found (${((lagRelationships.length / relationships.length) * 100).toFixed(1)}% of total).`
            };
        }

        function checkRelationshipTypes(relationships) {
            const fsRelationships = relationships.filter(rel => 
                !rel.pred_type || rel.pred_type === 'PR_FS'
            );
            
            const nonFSRelationships = relationships.filter(rel => 
                rel.pred_type && rel.pred_type !== 'PR_FS'
            );

            const percentage = relationships.length > 0 ? (fsRelationships.length / relationships.length) * 100 : 100;
            const status = percentage >= 90 ? 'pass' : percentage >= 80 ? 'warning' : 'fail';

            return {
                number: 4,
                title: 'Relationship Types',
                description: 'Finish-to-Start relationships should comprise ≥90% of all relationships.',
                status: status,
                details: {
                    fsRelationships: fsRelationships.length,
                    nonFSRelationships: nonFSRelationships.length,
                    totalRelationships: relationships.length,
                    percentage: percentage.toFixed(1)
                },
                failedItems: {
                    nonFSRelationships: nonFSRelationships.slice(0, 50).map(rel => {
                        const predActivity = allActivities.find(a => a.task_id === rel.pred_task_id);
                        const succActivity = allActivities.find(a => a.task_id === rel.task_id);
                        return {
                            id: rel.task_pred_id,
                            predCode: predActivity ? predActivity.task_code : rel.pred_task_id,
                            predName: predActivity ? predActivity.task_name : 'Unknown',
                            succCode: succActivity ? succActivity.task_code : rel.task_id,
                            succName: succActivity ? succActivity.task_name : 'Unknown',
                            type: rel.pred_type || 'FS',
                            lagHours: rel.lag_hr_cnt || 0
                        };
                    })
                },
                message: status === 'pass' ? 
                    'Relationship types are properly distributed.' : 
                    `Only ${percentage.toFixed(1)}% of relationships are Finish-to-Start.`
            };
        }

        function checkHardConstraints(activities) {
            // In a real implementation, you'd check for hard constraints
            // For now, we'll assume no hard constraints if dates are calculated
            const constrainedActivities = activities.filter(a => 
                a.cstr_type && a.cstr_type !== 'CS_ALAP' && a.cstr_type !== 'CS_ASAP'
            ).length;

            const status = constrainedActivities === 0 ? 'pass' : constrainedActivities <= activities.length * 0.05 ? 'warning' : 'fail';

            return {
                number: 5,
                title: 'Hard Constraints',
                description: 'Minimize hard constraints (Must Start On, Must Finish On, etc.).',
                status: status,
                details: {
                    constrainedActivities: constrainedActivities,
                    totalActivities: activities.length,
                    percentage: activities.length > 0 ? (constrainedActivities / activities.length * 100).toFixed(1) : 0
                },
                message: status === 'pass' ? 
                    'No hard constraints detected.' : 
                    `${constrainedActivities} activities have hard constraints.`
            };
        }

        function checkHighFloat(activities) {
            const highFloatActivities = activities.filter(a => 
                parseFloat(a.total_float_hr_cnt || 0) > 168 // More than 1 week (168 hours)
            );

            const percentage = activities.length > 0 ? (highFloatActivities.length / activities.length) * 100 : 0;
            const status = percentage <= 5 ? 'pass' : percentage <= 10 ? 'warning' : 'fail';

            return {
                number: 6,
                title: 'High Float',
                description: 'Activities with >1 week of float should be ≤5% of total activities.',
                status: status,
                details: {
                    highFloatActivities: highFloatActivities.length,
                    totalActivities: activities.length,
                    percentage: percentage.toFixed(1)
                },
                failedItems: {
                    highFloatActivities: highFloatActivities.slice(0, 50).map(a => ({
                        id: a.task_id,
                        code: a.task_code,
                        name: a.task_name,
                        floatHours: parseFloat(a.total_float_hr_cnt || 0),
                        floatDays: (parseFloat(a.total_float_hr_cnt || 0) / 8).toFixed(1),
                        status: a.status_code || 'Unknown'
                    }))
                },
                message: status === 'pass' ? 
                    'High float activities are within acceptable limits.' : 
                    `${highFloatActivities.length} activities have >1 week of float (${percentage.toFixed(1)}%).`
            };
        }

        function checkNegativeFloat(activities) {
            const negativeFloatActivities = activities.filter(a => 
                parseFloat(a.total_float_hr_cnt || 0) < 0
            );

            const status = negativeFloatActivities.length === 0 ? 'pass' : 'fail';

            return {
                number: 7,
                title: 'Negative Float',
                description: 'No activities should have negative float.',
                status: status,
                details: {
                    negativeFloatActivities: negativeFloatActivities.length,
                    totalActivities: activities.length
                },
                failedItems: {
                    negativeFloatActivities: negativeFloatActivities.slice(0, 50).map(a => ({
                        id: a.task_id,
                        code: a.task_code,
                        name: a.task_name,
                        floatHours: parseFloat(a.total_float_hr_cnt || 0),
                        floatDays: (parseFloat(a.total_float_hr_cnt || 0) / 8).toFixed(1),
                        status: a.status_code || 'Unknown'
                    }))
                },
                message: status === 'pass' ? 
                    'No activities with negative float.' : 
                    `${negativeFloatActivities.length} activities have negative float.`
            };
        }

        function checkHighDuration(activities) {
            const highDurationActivities = activities.filter(a => 
                parseFloat(a.target_drtn_hr_cnt || 0) > 960 // More than 6 weeks (960 hours)
            );

            const percentage = activities.length > 0 ? (highDurationActivities.length / activities.length) * 100 : 0;
            const status = percentage <= 5 ? 'pass' : percentage <= 10 ? 'warning' : 'fail';

            return {
                number: 8,
                title: 'High Duration',
                description: 'Activities >6 weeks duration should be ≤5% of total activities.',
                status: status,
                details: {
                    highDurationActivities: highDurationActivities.length,
                    totalActivities: activities.length,
                    percentage: percentage.toFixed(1)
                },
                failedItems: {
                    highDurationActivities: highDurationActivities.slice(0, 50).map(a => ({
                        id: a.task_id,
                        code: a.task_code,
                        name: a.task_name,
                        durationHours: parseFloat(a.target_drtn_hr_cnt || 0),
                        durationDays: (parseFloat(a.target_drtn_hr_cnt || 0) / 8).toFixed(1),
                        durationWeeks: (parseFloat(a.target_drtn_hr_cnt || 0) / 40).toFixed(1),
                        status: a.status_code || 'Unknown'
                    }))
                },
                message: status === 'pass' ? 
                    'Activity durations are within acceptable limits.' : 
                    `${highDurationActivities.length} activities are >6 weeks duration (${percentage.toFixed(1)}%).`
            };
        }

        function checkInvalidDates(activities) {
            const invalidDateActivities = activities.filter(a => {
                const startDate = a.act_start_date || a.early_start_date;
                const endDate = a.act_end_date || a.early_end_date;
                return !startDate || !endDate || new Date(startDate) > new Date(endDate);
            });

            const status = invalidDateActivities.length === 0 ? 'pass' : 'fail';

            return {
                number: 9,
                title: 'Invalid Dates',
                description: 'All activities must have valid start and finish dates.',
                status: status,
                details: {
                    invalidDateActivities: invalidDateActivities.length,
                    totalActivities: activities.length
                },
                failedItems: {
                    invalidDateActivities: invalidDateActivities.slice(0, 50).map(a => {
                        const startDate = a.act_start_date || a.early_start_date;
                        const endDate = a.act_end_date || a.early_end_date;
                        return {
                            id: a.task_id,
                            code: a.task_code,
                            name: a.task_name,
                            startDate: startDate || 'Missing',
                            endDate: endDate || 'Missing',
                            issue: !startDate ? 'No start date' : !endDate ? 'No end date' : 'End before start',
                            status: a.status_code || 'Unknown'
                        };
                    })
                },
                message: status === 'pass' ? 
                    'All activities have valid dates.' : 
                    `${invalidDateActivities.length} activities have invalid or missing dates.`
            };
        }

        function checkResources(activities, assignments) {
            const activitiesWithResources = new Set();
            assignments.forEach(assignment => {
                activitiesWithResources.add(assignment.task_id);
            });

            const workActivities = activities.filter(a => 
                parseFloat(a.target_drtn_hr_cnt || 0) > 0
            );

            const unresourcedActivities = workActivities.filter(a => 
                !activitiesWithResources.has(a.task_id)
            );

            const resourcedActivities = workActivities.filter(a => 
                activitiesWithResources.has(a.task_id)
            );

            const percentage = workActivities.length > 0 ? (resourcedActivities.length / workActivities.length) * 100 : 100;
            const status = percentage >= 95 ? 'pass' : percentage >= 80 ? 'warning' : 'fail';

            return {
                number: 10,
                title: 'Resources',
                description: 'All work activities should have resources assigned (≥95%).',
                status: status,
                details: {
                    resourcedActivities: resourcedActivities.length,
                    workActivities: workActivities.length,
                    unresourcedActivities: unresourcedActivities.length,
                    percentage: percentage.toFixed(1)
                },
                failedItems: {
                    unresourcedActivities: unresourcedActivities.slice(0, 50).map(a => ({
                        id: a.task_id,
                        code: a.task_code,
                        name: a.task_name,
                        durationDays: (parseFloat(a.target_drtn_hr_cnt || 0) / 8).toFixed(1),
                        status: a.status_code || 'Unknown'
                    }))
                },
                message: status === 'pass' ? 
                    'Resource assignment coverage is adequate.' : 
                    `Only ${percentage.toFixed(1)}% of work activities have resources assigned.`
            };
        }

        function checkIncompleteActivities(activities) {
            const incompleteActivities = activities.filter(a => 
                a.status_code === 'TK_Active' && 
                parseFloat(a.phys_complete_pct || 0) === 0
            );

            const activeActivities = activities.filter(a => 
                a.status_code === 'TK_Active'
            );

            const percentage = activeActivities.length > 0 ? (incompleteActivities.length / activeActivities.length) * 100 : 0;
            const status = percentage <= 5 ? 'pass' : percentage <= 10 ? 'warning' : 'fail';

            return {
                number: 11,
                title: 'Incomplete Activities',
                description: 'Active activities with 0% progress should be ≤5% of active activities.',
                status: status,
                details: {
                    incompleteActivities: incompleteActivities.length,
                    activeActivities: activeActivities.length,
                    percentage: percentage.toFixed(1)
                },
                failedItems: {
                    incompleteActivities: incompleteActivities.slice(0, 50).map(a => ({
                        id: a.task_id,
                        code: a.task_code,
                        name: a.task_name,
                        durationDays: (parseFloat(a.target_drtn_hr_cnt || 0) / 8).toFixed(1),
                        startDate: a.act_start_date || a.early_start_date || 'Not set',
                        status: a.status_code || 'Unknown'
                    }))
                },
                message: status === 'pass' ? 
                    'Active activity progress reporting is good.' : 
                    `${incompleteActivities.length} active activities have 0% progress (${percentage.toFixed(1)}%).`
            };
        }

        function checkCriticalPath(activities) {
            const criticalActivities = activities.filter(a => 
                parseFloat(a.total_float_hr_cnt || 0) === 0 || 
                a.driving_path_flag === 'Y'
            ).length;

            const percentage = activities.length > 0 ? (criticalActivities / activities.length) * 100 : 0;
            const status = percentage >= 5 && percentage <= 15 ? 'pass' : 'warning';

            return {
                number: 12,
                title: 'Critical Path Test',
                description: 'Critical path should be 5-15% of total activities.',
                status: status,
                details: {
                    criticalActivities: criticalActivities,
                    totalActivities: activities.length,
                    percentage: percentage.toFixed(1)
                },
                message: status === 'pass' ? 
                    'Critical path length is within optimal range.' : 
                    `Critical path is ${percentage.toFixed(1)}% of total activities.`
            };
        }

        function checkCD1() {
            // CD-1 checks are project-specific and may not apply to all projects
            return {
                number: 13,
                title: 'CD-1 Baseline',
                description: 'CD-1 baseline requirements (project-specific).',
                status: 'pass',
                details: {
                    applicable: false
                },
                message: 'CD-1 requirements not applicable for this project type.'
            };
        }

        function checkCD234() {
            // CD-2/3/4 checks are project-specific and may not apply to all projects
            return {
                number: 14,
                title: 'CD-2/3/4 Requirements',
                description: 'CD-2/3/4 baseline requirements (project-specific).',
                status: 'pass',
                details: {
                    applicable: false
                },
                message: 'CD-2/3/4 requirements not applicable for this project type.'
            };
        }

        function displayIntegrityResults() {
            const resultsContainer = document.getElementById('integrityResults');
            const results = integrityCheckResults;

            const summaryHtml = `
                <div class="integrity-summary">
                    <div class="summary-score">${results.summary.score}%</div>
                    <div class="summary-grade">Grade: ${results.summary.grade}</div>
                    <div class="summary-breakdown">
                        <div class="breakdown-item">
                            <div class="breakdown-count">${results.summary.passedPoints}</div>
                            <div class="breakdown-label">Passed</div>
                        </div>
                        <div class="breakdown-item">
                            <div class="breakdown-count">${results.summary.warningPoints}</div>
                            <div class="breakdown-label">Warnings</div>
                        </div>
                        <div class="breakdown-item">
                            <div class="breakdown-count">${results.summary.failedPoints}</div>
                            <div class="breakdown-label">Failed</div>
                        </div>
                    </div>
                </div>
            `;

            const pointsHtml = results.points.map((point, index) => `
                <div class="dcma-point ${point.status}">
                    <h4 onclick="toggleDCMAPoint(${index})">
                        Point ${point.number}: ${point.title}
                        <span class="dcma-status ${point.status}">
                            ${point.status === 'pass' ? '✅ PASS' : 
                              point.status === 'warning' ? '⚠️ WARNING' : '❌ FAIL'}
                        </span>
                        <span class="dcma-expand-icon" id="expand-icon-${index}">🔽</span>
                    </h4>
                    <div class="dcma-summary">
                        <p><strong>Result:</strong> ${point.message}</p>
                    </div>
                    <div class="dcma-expandable" id="expandable-${index}">
                        <div class="dcma-expandable-content">
                            <p><strong>Description:</strong> ${point.description}</p>
                            <div class="dcma-details">
                                <h5>📊 Detailed Metrics:</h5>
                                ${Object.entries(point.details).map(([key, value]) => 
                                    `<div class="dcma-metric">
                                        <strong>${formatMetricLabel(key)}:</strong> 
                                        <span>${formatMetricValue(key, value)}</span>
                                    </div>`
                                ).join('')}
                            </div>
                            ${generateRecommendations(point)}
                            ${generateImpactAnalysis(point)}
                            ${generateFailedItemsList(point)}
                        </div>
                    </div>
                </div>
            `).join('');

            resultsContainer.innerHTML = summaryHtml + pointsHtml;
        }

        function generateFailedItemsList(point) {
            if (!point.failedItems || point.status === 'pass') {
                return '';
            }

            console.log('Generating failed items for point', point.number, point.failedItems); // Debug log

            let html = '<div class="failed-items-section"><h5>🔍 Items Requiring Action:</h5>';

            // Handle different types of failed items based on the point
            switch (point.number) {
                case 1: // Logic
                    if (point.failedItems.danglingActivities && point.failedItems.danglingActivities.length > 0) {
                        html += generateActivityTable('Dangling Activities (No Predecessors or Successors)', 
                            point.failedItems.danglingActivities, ['code', 'name', 'duration']);
                    }
                    if (point.failedItems.activitiesWithoutPred && point.failedItems.activitiesWithoutPred.length > 0) {
                        html += generateActivityTable('Activities Without Predecessors', 
                            point.failedItems.activitiesWithoutPred, ['code', 'name', 'duration']);
                    }
                    if (point.failedItems.activitiesWithoutSucc && point.failedItems.activitiesWithoutSucc.length > 0) {
                        html += generateActivityTable('Activities Without Successors', 
                            point.failedItems.activitiesWithoutSucc, ['code', 'name', 'duration']);
                    }
                    break;

                case 2: // Leads
                    if (point.failedItems.leadRelationships && point.failedItems.leadRelationships.length > 0) {
                        html += generateRelationshipTable('Lead Relationships', point.failedItems.leadRelationships);
                    }
                    break;

                case 3: // Lags
                    if (point.failedItems.lagRelationships && point.failedItems.lagRelationships.length > 0) {
                        html += generateLagRelationshipTable('Lag Relationships', point.failedItems.lagRelationships);
                    }
                    break;

                case 4: // Relationship Types
                    if (point.failedItems.nonFSRelationships && point.failedItems.nonFSRelationships.length > 0) {
                        html += generateRelationshipTable('Non-Finish-to-Start Relationships', point.failedItems.nonFSRelationships);
                    }
                    break;

                case 6: // High Float
                    if (point.failedItems.highFloatActivities && point.failedItems.highFloatActivities.length > 0) {
                        html += generateActivityTable('High Float Activities (>1 Week)', 
                            point.failedItems.highFloatActivities, ['code', 'name', 'floatDays', 'status']);
                    }
                    break;

                case 7: // Negative Float
                    if (point.failedItems.negativeFloatActivities && point.failedItems.negativeFloatActivities.length > 0) {
                        html += generateActivityTable('Negative Float Activities', 
                            point.failedItems.negativeFloatActivities, ['code', 'name', 'floatDays', 'status']);
                    }
                    break;

                case 8: // High Duration
                    if (point.failedItems.highDurationActivities && point.failedItems.highDurationActivities.length > 0) {
                        html += generateActivityTable('Long Duration Activities (>6 Weeks)', 
                            point.failedItems.highDurationActivities, ['code', 'name', 'durationWeeks', 'status']);
                    }
                    break;

                case 9: // Invalid Dates
                    if (point.failedItems.invalidDateActivities && point.failedItems.invalidDateActivities.length > 0) {
                        html += generateInvalidDateTable('Activities with Invalid Dates', point.failedItems.invalidDateActivities);
                    }
                    break;

                case 10: // Resources
                    if (point.failedItems.unresourcedActivities && point.failedItems.unresourcedActivities.length > 0) {
                        html += generateActivityTable('Activities Without Resources', 
                            point.failedItems.unresourcedActivities, ['code', 'name', 'durationDays', 'status']);
                    }
                    break;

                case 11: // Incomplete Activities
                    if (point.failedItems.incompleteActivities && point.failedItems.incompleteActivities.length > 0) {
                        html += generateIncompleteActivityTable('Active Activities with 0% Progress', 
                            point.failedItems.incompleteActivities);
                    }
                    break;
            }

            // If no specific failed items were added but the point failed, show a generic message
            if (html === '<div class="failed-items-section"><h5>🔍 Items Requiring Action:</h5>' && (point.status === 'fail' || point.status === 'warning')) {
                html += '<p>Detailed item list not available for this check. Please review the metrics above and consult the recommendations for guidance.</p>';
            }

            html += '</div>';
            return html;
        }

        function generateInvalidDateTable(title, activities) {
            if (!activities || activities.length === 0) return '';

            let html = `
                <div class="failed-items-table">
                    <h6>${title} (${activities.length} items)</h6>
                    <div class="table-container">
                        <table class="integrity-items-table">
                            <thead>
                                <tr>
                                    <th>Activity Code</th>
                                    <th>Activity Name</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Issue</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            activities.forEach(activity => {
                html += `
                    <tr>
                        <td><strong>${activity.code}</strong></td>
                        <td>${activity.name}</td>
                        <td>${activity.startDate}</td>
                        <td>${activity.endDate}</td>
                        <td><span style="color: #dc3545; font-weight: bold;">${activity.issue}</span></td>
                        <td>${getStatusLabel(activity.status)}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            
            html += '</div></div>';
            return html;
        }

        function generateLagRelationshipTable(title, relationships) {
            if (!relationships || relationships.length === 0) return '';

            let html = `
                <div class="failed-items-table">
                    <h6>${title} (${relationships.length} items)</h6>
                    <div class="table-container">
                        <table class="integrity-items-table">
                            <thead>
                                <tr>
                                    <th>Predecessor</th>
                                    <th>Successor</th>
                                    <th>Type</th>
                                    <th>Lag (hrs)</th>
                                    <th>Lag (days)</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            relationships.forEach(rel => {
                html += `
                    <tr>
                        <td><strong>${rel.predCode}</strong><br><small>${rel.predName}</small></td>
                        <td><strong>${rel.succCode}</strong><br><small>${rel.succName}</small></td>
                        <td>${rel.type}</td>
                        <td>${rel.lagHours}</td>
                        <td>${rel.lagDays}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            
            html += '</div></div>';
            return html;
        }

        function generateIncompleteActivityTable(title, activities) {
            if (!activities || activities.length === 0) return '';

            let html = `
                <div class="failed-items-table">
                    <h6>${title} (${activities.length} items)</h6>
                    <div class="table-container">
                        <table class="integrity-items-table">
                            <thead>
                                <tr>
                                    <th>Activity Code</th>
                                    <th>Activity Name</th>
                                    <th>Duration (days)</th>
                                    <th>Start Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            activities.forEach(activity => {
                html += `
                    <tr>
                        <td><strong>${activity.code}</strong></td>
                        <td>${activity.name}</td>
                        <td>${activity.durationDays}</td>
                        <td>${activity.startDate}</td>
                        <td>${getStatusLabel(activity.status)}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            html += '</div></div>';
            return html;
        }

        function generateActivityTable(title, activities, columns) {
            if (!activities || activities.length === 0) return '';

            const columnHeaders = {
                code: 'Activity Code',
                name: 'Activity Name',
                duration: 'Duration (hrs)',
                floatDays: 'Float (days)',
                durationWeeks: 'Duration (weeks)',
                status: 'Status'
            };

            let html = `
                <div class="failed-items-table">
                    <h6>${title} (${activities.length} items)</h6>
                    <div class="table-container">
                        <table class="integrity-items-table">
                            <thead>
                                <tr>
                                    ${columns.map(col => `<th>${columnHeaders[col]}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
            `;

            activities.forEach(activity => {
                html += '<tr>';
                columns.forEach(col => {
                    let value = activity[col];
                    if (col === 'duration' && typeof value === 'number') {
                        value = value.toLocaleString();
                    } else if (col === 'status') {
                        value = getStatusLabel(value);
                    }
                    html += `<td>${value || 'N/A'}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            
            html += '</div></div>';
            return html;
        }

        function generateRelationshipTable(title, relationships) {
            if (!relationships || relationships.length === 0) return '';

            let html = `
                <div class="failed-items-table">
                    <h6>${title} (${relationships.length} items)</h6>
                    <div class="table-container">
                        <table class="integrity-items-table">
                            <thead>
                                <tr>
                                    <th>Predecessor</th>
                                    <th>Successor</th>
                                    <th>Type</th>
                                    <th>Lag (hrs)</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            relationships.forEach(rel => {
                html += `
                    <tr>
                        <td><strong>${rel.predCode}</strong><br><small>${rel.predName}</small></td>
                        <td><strong>${rel.succCode}</strong><br><small>${rel.succName}</small></td>
                        <td>${rel.type}</td>
                        <td>${rel.lagHours}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            
            html += '</div></div>';
            return html;
        }

        function toggleDCMAPoint(index) {
            const expandable = document.getElementById(`expandable-${index}`);
            const icon = document.getElementById(`expand-icon-${index}`);
            
            if (expandable.classList.contains('expanded')) {
                expandable.classList.remove('expanded');
                icon.classList.remove('expanded');
                icon.textContent = '🔽';
            } else {
                expandable.classList.add('expanded');
                icon.classList.add('expanded');
                icon.textContent = '🔼';
            }
        }

        function formatMetricLabel(key) {
            const labels = {
                'danglingActivities': 'Dangling Activities',
                'startMilestones': 'Start Milestones',
                'finishMilestones': 'Finish Milestones',
                'totalActivities': 'Total Activities',
                'leadsCount': 'Lead Relationships',
                'lagsCount': 'Lag Relationships',
                'totalRelationships': 'Total Relationships',
                'percentage': 'Percentage',
                'fsRelationships': 'Finish-to-Start Relationships',
                'constrainedActivities': 'Constrained Activities',
                'highFloatActivities': 'High Float Activities',
                'negativeFloatActivities': 'Negative Float Activities',
                'highDurationActivities': 'Long Duration Activities',
                'invalidDateActivities': 'Invalid Date Activities',
                'resourcedActivities': 'Resourced Activities',
                'workActivities': 'Work Activities',
                'incompleteActivities': 'Incomplete Active Activities',
                'activeActivities': 'Active Activities',
                'criticalActivities': 'Critical Activities',
                'applicable': 'Applicable to Project'
            };
            return labels[key] || key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        }

        function formatMetricValue(key, value) {
            if (key === 'percentage') {
                return `${value}%`;
            } else if (key === 'applicable') {
                return value ? 'Yes' : 'No';
            } else if (typeof value === 'number') {
                return value.toLocaleString();
            }
            return value;
        }

        function generateRecommendations(point) {
            const recommendations = {
                1: [
                    "Ensure all activities have at least one predecessor and successor",
                    "Add start and finish milestones to properly anchor the schedule",
                    "Review activities without logic ties and add appropriate relationships"
                ],
                2: [
                    "Minimize use of lead relationships - they can indicate unrealistic scheduling",
                    "Consider using lag instead of lead where possible",
                    "Review lead relationships to ensure they represent actual work dependencies"
                ],
                3: [
                    "Review lag relationships to ensure they represent real waiting time",
                    "Consider breaking down activities with large lags into smaller components",
                    "Document the reason for each lag relationship"
                ],
                4: [
                    "Convert Start-to-Start and Finish-to-Finish relationships to Finish-to-Start where possible",
                    "Use Start-to-Start relationships only when work can truly begin in parallel",
                    "Ensure relationship types accurately reflect the work logic"
                ],
                5: [
                    "Remove unnecessary date constraints and let the schedule calculate naturally",
                    "Use constraints only when there are real external dependencies",
                    "Document the business reason for each constraint"
                ],
                6: [
                    "Review activities with high float to ensure they are on a reasonable path",
                    "Consider adding missing logic to reduce excessive float",
                    "Verify resource availability for high-float activities"
                ],
                7: [
                    "Resolve negative float by adjusting logic, durations, or constraints",
                    "Negative float indicates the schedule may not be achievable as planned",
                    "Consider resource leveling or scope adjustments"
                ],
                8: [
                    "Break down long-duration activities into smaller, manageable components",
                    "Long activities reduce schedule flexibility and increase risk",
                    "Consider adding interim milestones for long activities"
                ],
                9: [
                    "Verify all activity dates are logical and achievable",
                    "Check for activities with finish dates before start dates",
                    "Ensure baseline dates are properly set"
                ],
                10: [
                    "Assign resources to all work activities for realistic scheduling",
                    "Resource assignments enable proper resource leveling",
                    "Use appropriate resource types (labor, material, equipment)"
                ],
                11: [
                    "Update progress on active activities regularly",
                    "Zero percent progress on active activities may indicate reporting issues",
                    "Implement regular progress monitoring procedures"
                ],
                12: [
                    "Review critical path to ensure it represents the longest path through the project",
                    "Too many critical activities may indicate over-constraining",
                    "Too few critical activities may indicate missing logic"
                ],
                13: [
                    "Project-specific requirements - consult project documentation",
                    "Ensure compliance with organizational standards"
                ],
                14: [
                    "Project-specific requirements - consult project documentation",
                    "Ensure compliance with organizational standards"
                ]
            };

            const pointRecommendations = recommendations[point.number] || [];
            
            if (pointRecommendations.length === 0 || point.status === 'pass') {
                return point.status === 'pass' ? 
                    '<div class="dcma-recommendations"><h5>✅ No Action Required</h5><p>This point meets DCMA standards.</p></div>' : '';
            }

            return `
                <div class="dcma-recommendations">
                    <h5>💡 Recommendations:</h5>
                    <ul>
                        ${pointRecommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function generateImpactAnalysis(point) {
            const impacts = {
                1: "Poor logic affects schedule reliability and makes it difficult to track critical path changes.",
                2: "Excessive leads can create unrealistic schedules and hide true dependencies.",
                3: "Too many lags may indicate incomplete planning or unrealistic constraints.",
                4: "Improper relationship types can create scheduling logic errors and unrealistic dates.",
                5: "Hard constraints reduce schedule flexibility and may cause artificial critical paths.",
                6: "High float activities may not be on the critical path when they should be.",
                7: "Negative float indicates the schedule is not achievable as currently planned.",
                8: "Long activities reduce schedule granularity and increase risk exposure.",
                9: "Invalid dates compromise schedule integrity and analysis capabilities.",
                10: "Missing resources prevent realistic scheduling and resource optimization.",
                11: "Poor progress tracking reduces schedule accuracy and forecasting ability.",
                12: "Critical path issues affect project completion date predictions.",
                13: "Non-compliance with CD-1 requirements may affect project approval.",
                14: "Non-compliance with CD-2/3/4 requirements may affect project execution."
            };

            const impact = impacts[point.number];
            
            if (!impact || point.status === 'pass') {
                return '';
            }

            const severityClass = point.status === 'fail' ? 'high-impact' : 'medium-impact';
            
            return `
                <div class="dcma-impact ${severityClass}">
                    <h5>⚠️ Impact Analysis:</h5>
                    <p>${impact}</p>
                </div>
            `;
        }

        function exportIntegrityReportCSV() {
            if (!integrityCheckResults) {
                showError('No integrity check results to export. Please run the integrity check first.');
                return;
            }

            const csvData = integrityCheckResults.points.map(point => ({
                'Point': point.number,
                'Title': point.title,
                'Status': point.status.toUpperCase(),
                'Description': point.description,
                'Result': point.message,
                'Details': Object.entries(point.details).map(([k,v]) => `${k}: ${v}`).join('; ')
            }));

            const csv = generateCSV(csvData, [
                { key: 'Point', label: 'Point' },
                { key: 'Title', label: 'Title' },
                { key: 'Status', label: 'Status' },
                { key: 'Description', label: 'Description' },
                { key: 'Result', label: 'Result' },
                { key: 'Details', label: 'Details' }
            ]);

            downloadFile(csv, 'dcma14_integrity_report.csv', 'text/csv');
        }

        function exportIntegrityReportJSON() {
            if (!integrityCheckResults) {
                showError('No integrity check results to export. Please run the integrity check first.');
                return;
            }

            const exportData = {
                project: {
                    name: currentProject.proj_name,
                    shortName: currentProject.proj_short_name,
                    id: currentProject.proj_id
                },
                assessment: {
                    type: 'DCMA 14-Point Schedule Integrity Assessment',
                    assessmentDate: new Date().toISOString(),
                    summary: integrityCheckResults.summary,
                    points: integrityCheckResults.points
                },
                metadata: {
                    totalActivities: allActivities.length,
                    totalRelationships: currentReader.relationships ? currentReader.relationships.length : 0,
                    totalResources: currentReader.resources ? currentReader.resources.length : 0
                }
            };

            const json = JSON.stringify(exportData, null, 2);
            downloadFile(json, 'dcma14_integrity_report.json', 'application/json');
        }
    </script>
</body>
</html>
